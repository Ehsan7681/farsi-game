<!DOCTYPE html>
<html lang="fa" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Ù…Ø²Ø±Ø¹Ù‡ Ú©Ù„Ù…Ø§Øª</title>

    <!-- PWA ADDITION: Meta tags for theme color, manifest, and icons -->
    <meta name="theme-color" content="#87CEEB">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icons/icon-192x192.png">
    <link rel="icon" type="image/png" href="icons/icon-192x192.png">
    <!-- End PWA ADDITION -->

    <script src="https://cdn.tailwindcss.com"></script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;700;800&display=swap" rel="stylesheet">

    <style>
        body {
            font-family: 'Vazirmatn', sans-serif;
            touch-action: manipulation;
            overflow: hidden;
            background: linear-gradient(to bottom, #87CEEB, #fef3c7);
        }

        .text-shadow {
            text-shadow: 2px 2px 4px rgba(0,0,0,0.4);
        }

        .letter-draggable {
            touch-action: none;
            cursor: grab;
            transition: transform 0.2s ease-in-out, box-shadow 0.2s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .letter-draggable.dragging {
            position: absolute;
            cursor: grabbing;
            transform: scale(1.2);
            z-index: 1000;
            opacity: 0.95;
            box-shadow: 0 10px 15px rgba(0,0,0,0.2);
            transition: none;
        }

        .letter-dropzone {
            transition: background-color 0.2s ease, transform 0.2s ease;
        }

        .letter-dropzone.drag-over {
            background-color: #a7f3d0;
            transform: scale(1.05);
            border-style: solid;
        }

        @keyframes growAndShine {
            0% { transform: scale(0.5); opacity: 0.5; }
            70% { transform: scale(1.2); opacity: 1; }
            100% { transform: scale(1); opacity: 1; }
        }
        .crop-grown {
            animation: growAndShine 0.8s ease-out;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(0.5); opacity: 1; }
            100% { transform: translateY(-80px) scale(1.5); opacity: 0; }
        }
        .coin-animation {
            position: absolute;
            animation: floatUp 1s ease-out forwards;
        }

        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }
        .animate-shake {
            animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both;
        }

        @keyframes fertileGlow {
            0% { box-shadow: 0 0 10px 2px #fde047; }
            50% { box-shadow: 0 0 20px 8px #fde047; }
            100% { box-shadow: 0 0 10px 2px #fde047; }
        }
        .fertile-plot {
            animation: fertileGlow 2s infinite;
            border: 2px solid #fbbf24;
        }

        .farm-plot {
            background-color: #A1662F;
            border-bottom: 8px solid #6B4226;
        }
        .farm-plot.planted {
             background-color: #597D35;
             border-bottom-color: #3C5826;
        }

        @keyframes flyAcross {
            from { transform: translateX(110vw); }
            to { transform: translateX(-100px); }
        }
        .flying-bird {
            position: absolute;
            opacity: 0.5;
            animation: flyAcross linear infinite;
        }
    </style>
</head>
<body class="antialiased overflow-hidden h-screen w-screen flex flex-col items-center justify-center p-2">

    <div id="game-container" class="w-full max-w-lg h-full bg-sky-400 rounded-2xl shadow-2xl p-4 flex flex-col relative overflow-hidden border-4 border-amber-800">

        <div id="sky-elements" class="absolute inset-0 z-0 overflow-hidden">
            <img src="sky.png" class="flying-bird" style="width: 70px; top: 15%; animation-duration: 20s; animation-delay: -5s;" onerror="this.style.display='none';">
            <img src="sky.png" class="flying-bird" style="width: 50px; top: 25%; animation-duration: 15s; animation-delay: 0s;" onerror="this.style.display='none';">
            <img src="sky.png" class="flying-bird" style="width: 60px; top: 35%; animation-duration: 25s; animation-delay: -10s;" onerror="this.style.display='none';">
        </div>

        <div class="absolute bottom-4 left-4 z-20">
            <button onclick="openSettingsModal()" class="w-16 h-16 text-5xl transform transition hover:scale-110 text-shadow">
                âš™ï¸
            </button>
        </div>

        <header class="flex justify-between items-center w-full mb-4 z-10 h-20">
            <div class="w-20 h-20">
                <img id="sun-img" src="sun.png" alt="Ø®ÙˆØ±Ø´ÛŒØ¯" class="w-full h-full object-contain" onerror="this.onerror=null; this.outerHTML='<div class=\'w-20 h-20 bg-yellow-300 rounded-full\'></div>';">
            </div>

            <div class="flex items-center">
                <span id="coin-counter" class="text-4xl font-bold text-white text-shadow mr-2">0</span>
                <span class="text-5xl">ğŸ’°</span>
            </div>
        </header>

        <main class="flex-grow flex flex-col justify-center items-center relative -mt-8">
            <div class="absolute inset-0 bg-cover bg-bottom" style="background-image: url('grassland.png');" onerror="this.style.backgroundImage='none'; this.style.backgroundColor='#90EE90';"></div>

            <h1 class="text-6xl font-extrabold text-white z-10 mb-8 text-shadow">Ù…Ø²Ø±Ø¹Ù‡ Ú©Ù„Ù…Ø§Øª</h1>

            <div class="grid grid-cols-3 gap-4 md:gap-6 z-10"></div>

            <div id="scarecrow" class="absolute bottom-4 right-2 w-24 h-24 flex flex-col items-center z-10">
                 <div id="scarecrow-speech-bubble" class="hidden absolute -top-24 -right-2 bg-white p-3 rounded-lg shadow-md text-center text-sm w-44">
                    Ø±ÙˆÛŒ ÛŒÚ© Ø²Ù…ÛŒÙ† Ø®Ø§Ù„ÛŒ Ú©Ù„ÛŒÚ© Ú©Ù† ØªØ§ ÛŒÚ© Ú©Ù„Ù…Ù‡ Ø¨Ú©Ø§Ø±ÛŒ!
                 </div>
                 <img id="scarecrow-img" src="scarecrow.png" alt="Ù…ØªØ±Ø³Ú© Ø±Ø§Ù‡Ù†Ù…Ø§" class="w-24 h-24 object-contain" onerror="this.onerror=null; this.outerHTML='<div class=\'text-6xl\'>ğŸ¤ </div>';">
            </div>
        </main>
    </div>

    <!-- Modals -->
    <div id="settings-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-yellow-50 rounded-xl shadow-lg p-6 w-full max-w-sm text-center">
            <h2 class="text-2xl font-bold text-amber-800 mb-6">ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h2>

            <div class="mt-6">
                 <button id="reset-game-button" class="w-full bg-red-500 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">
                    Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§Ø²ÛŒ
                 </button>
                 <p class="text-xs text-gray-500 mt-2">ØªÙ…Ø§Ù… Ù¾ÛŒØ´Ø±ÙØª Ø´Ù…Ø§ Ø­Ø°Ù Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯!</p>
            </div>

            <button onclick="closeSettingsModal()" class="mt-8 bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-full">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="seed-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-yellow-50 rounded-xl shadow-lg p-6 w-full max-w-md text-center">
            <h2 class="text-2xl font-bold text-amber-800 mb-4">ÛŒÚ© Ø¨Ø°Ø± Ø¨Ø±Ø§ÛŒ Ú©Ø§Ø´ØªÙ† Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†!</h2>
            <div id="lesson-container" class="space-y-4 max-h-[70vh] overflow-y-auto pr-2"></div>
            <button onclick="closeSeedModal()" class="mt-6 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">Ø¨Ø³ØªÙ†</button>
        </div>
    </div>

    <div id="minigame-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div id="minigame-content" class="bg-sky-100 rounded-xl shadow-lg p-6 w-full max-w-md text-center relative">
            <h2 class="text-2xl font-bold text-sky-800 mb-2">Ú©Ù„Ù…Ù‡ Ø±Ùˆ Ø¯Ø±Ø³Øª Ú©Ù†!</h2>
            <div id="minigame-image" class="text-6xl mb-4"></div>
            <div id="letter-dropzones" class="flex justify-center items-center gap-2 mb-6 h-20"></div>
            <div class="relative bg-white/50 p-4 rounded-lg h-24">
                 <div id="letter-draggables" class="flex justify-center items-center gap-3 h-full"></div>
            </div>
            <button onclick="closeMinigameModal()" class="mt-4 bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-full transition-transform transform hover:scale-105">Ø§Ù†ØµØ±Ø§Ù</button>
        </div>
    </div>

    <div id="message-modal" class="hidden fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-lg p-8 w-full max-w-sm text-center">
            <div id="message-icon" class="text-6xl mb-4"></div>
            <p id="message-text" class="text-xl font-semibold text-gray-700 mb-6"></p>
            <button onclick="closeMessageModal()" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full transition-transform transform hover:scale-105">Ø¨Ø§Ø´Ù‡!</button>
        </div>
    </div>

    <div id="start-game-overlay" class="fixed inset-0 bg-black/70 z-50 flex flex-col items-center justify-center cursor-pointer">
        <h1 class="text-5xl font-bold text-white mb-4">Ù…Ø²Ø±Ø¹Ù‡ Ú©Ù„Ù…Ø§Øª</h1>
        <p class="text-2xl text-yellow-300">Ø¨Ø±Ø§ÛŒ Ø´Ø±ÙˆØ¹ Ú©Ù„ÛŒÚ© Ú©Ù†ÛŒØ¯</p>
    </div>

    <script>
        // --- GAME DATA (CORRECTED & EXPANDED) ---
        const lessons = [
            { id: 1, title: 'Ø¯Ø±Ø³ Û±: Ø¢ Ø§ / Ø¨', words: [ { word: 'Ø¢Ø¨', letters: ['Ø¢', 'Ø¨'], crop: 'ğŸ’§' }, { word: 'Ø¨Ø§Ø¨Ø§', letters: ['Ø¨', 'Ø§', 'Ø¨', 'Ø§'], crop: 'ğŸ‘¨â€ğŸ‘§' } ] },
            { id: 2, title: 'Ø¯Ø±Ø³ Û²: Ø§Ù Ù / Ø¯', words: [ { word: 'Ø§Ø¯Ø¨', letters: ['Ø§Ù', 'Ø¯Ù', 'Ø¨'], crop: 'ğŸ“–' }, { word: 'Ø¯Ø§Ø¯', letters: ['Ø¯', 'Ø§', 'Ø¯'], crop: 'âš–ï¸' }, { word: 'Ø¨Ø§Ø¯', letters: ['Ø¨', 'Ø§', 'Ø¯'], crop: 'ğŸ’¨' } ] },
            { id: 3, title: 'Ø¯Ø±Ø³ Û³: Ù… / Ø³', words: [ { word: 'Ù…Ø§Ø¯Ø±', letters: ['Ù…Ø§', 'Ø¯ÙØ±'], crop: 'ğŸ‘©â€ğŸ‘§' }, { word: 'Ø§Ø³Ø¨', letters: ['Ø§ÙØ³', 'Ø¨'], crop: 'ğŸ' }, { word: 'Ø³Ø¨Ø¯', letters: ['Ø³Ù', 'Ø¨ÙØ¯'], crop: 'ğŸ§º' } ] },
            { id: 4, title: 'Ø¯Ø±Ø³ Û´: Ø§Ùˆ Ùˆ / Øª', words: [ { word: 'ØªÙˆØª', letters: ['ØªÙˆ', 'Øª'], crop: 'ğŸ“' }, { word: 'Ø¯ÙˆØ¯', letters: ['Ø¯Ùˆ', 'Ø¯'], crop: 'ğŸ’¨' }, { word: 'Ø¯Ø³Øª', letters: ['Ø¯ÙØ³', 'Øª'], crop: 'âœ‹' }, { word: 'Ø¢ØªÙˆ', letters: ['Ø¢', 'ØªÙˆ'], crop: 'ğŸƒ' } ] },
            { id: 5, title: 'Ø¯Ø±Ø³ Ûµ: Ø±', words: [ { word: 'Ø§Ø¨Ø±', letters: ['Ø§ÙØ¨', 'Ø±'], crop: 'â˜ï¸' }, { word: 'Ø¨Ø±Ø§Ø¯Ø±', letters: ['Ø¨Ù', 'Ø±Ø§', 'Ø¯ÙØ±'], crop: 'ğŸ‘¨â€ğŸ‘¦' }, { word: 'Ø¯Ø§Ø±Ø§', letters: ['Ø¯Ø§', 'Ø±Ø§'], crop: 'ğŸ§â€â™‚ï¸' }, { word: 'Ù…Ø§Ø±', letters: ['Ù…Ø§', 'Ø±'], crop: 'ğŸ' } ] },
            { id: 6, title: 'Ø¯Ø±Ø³ Û¶: Ù†', words: [ { word: 'Ù†Ø§Ù†', letters: ['Ù†Ø§', 'Ù†'], crop: 'ğŸ' }, { word: 'Ø§Ù†Ø§Ø±', letters: ['Ø§Ù', 'Ù†Ø§', 'Ø±'], crop: ' B' }, { word: 'Ø¨Ø§Ø±Ø§Ù†', letters: ['Ø¨Ø§', 'Ø±Ø§Ù†'], crop: 'ğŸŒ§ï¸' }, { word: 'Ø¯Ù†Ø¯Ø§Ù†', letters: ['Ø¯ÙÙ†', 'Ø¯Ø§Ù†'], crop: 'ğŸ¦·' } ] },
            { id: 7, title: 'Ø¯Ø±Ø³ Û·: Ø§ÛŒ', words: [ { word: 'Ø§ÛŒØ±Ø§Ù†', letters: ['Ø§ÛŒ', 'Ø±Ø§Ù†'], crop: 'ğŸ‡®ğŸ‡·' }, { word: 'Ø³ÛŒØ¨', letters: ['Ø³ÛŒ', 'Ø¨'], crop: 'ğŸ' }, { word: 'Ø¨ÛŒÙ†ÛŒ', letters: ['Ø¨ÛŒ', 'Ù†ÛŒ'], crop: 'ğŸ‘ƒ' }, { word: 'Ø³ÛŒÙ†ÛŒ', letters: ['Ø³ÛŒ', 'Ù†ÛŒ'], crop: 'ğŸ½ï¸' }, { word: 'Ø¢Ø¨ÛŒ', letters: ['Ø¢', 'Ø¨ÛŒ'], crop: 'ğŸ”µ' } ] },
            { id: 8, title: 'Ø¯Ø±Ø³ Û¸: Ø²', words: [ { word: 'Ø²Ù†Ø¨ÙˆØ±', letters: ['Ø²ÙÙ†', 'Ø¨ÙˆØ±'], crop: 'ğŸ' }, { word: 'Ù…ÛŒØ²', letters: ['Ù…ÛŒ', 'Ø²'], crop: 'ğŸ–¥ï¸' }, { word: 'Ø¨Ø§Ø²Ùˆ', letters: ['Ø¨Ø§', 'Ø²Ùˆ'], crop: 'ğŸ’ª' }, { word: 'Ø³Ø¨Ø²ÛŒ', letters: ['Ø³ÙØ¨', 'Ø²ÛŒ'], crop: 'ğŸ¥¬' }, { word: 'Ø²ÛŒÙ¾', letters: ['Ø²ÛŒ', 'Ù¾'], crop: 'ğŸ¤' } ] },
            { id: 9, title: 'Ø¯Ø±Ø³ Û¹: Ø§Ù Ù Ù€Ù‡ Ù‡', words: [ { word: 'Ø§ÙØ³Ù…', letters: ['Ø§ÙØ³', 'Ù…'], crop: 'ğŸ“›' }, { word: 'Ù¾Ø³Ø±', letters: ['Ù¾Ù', 'Ø³ÙØ±'], crop: 'ğŸ‘¦' }, { word: 'Ø³ØªØ§Ø±Ù‡', letters: ['Ø³Ù', 'ØªØ§', 'Ø±Ù‡'], crop: 'â­' }, { word: 'Ø¯Ø§Ù†Ù‡', letters: ['Ø¯Ø§', 'Ù†Ù‡'], crop: 'ğŸŒ±' }, { word: 'Ù†Ø±Ø¯Ù‡', letters: ['Ù†ÙØ±', 'Ø¯Ù‡'], crop: 'ğŸš§' } ] },
            { id: 10, title: 'Ø¯Ø±Ø³ Û±Û°: Ø´', words: [ { word: 'Ø´ÛŒØ±', letters: ['Ø´ÛŒ', 'Ø±'], crop: 'ğŸ¦' }, { word: 'Ø¢Ø´', letters: ['Ø¢', 'Ø´'], crop: 'ğŸ¥£' }, { word: 'Ù…Ø§Ø´ÛŒÙ†', letters: ['Ù…Ø§', 'Ø´ÛŒÙ†'], crop: 'ğŸš—' }, { word: 'Ø´Ø§Ù†Ù‡', letters: ['Ø´Ø§', 'Ù†Ù‡'], crop: ' B' }, { word: 'ØªØ±Ø§Ø´', letters: ['ØªÙ', 'Ø±Ø§Ø´'], crop: 'âœï¸' }, { word: 'Ø¯ÙˆØ´', letters: ['Ø¯Ùˆ', 'Ø´'], crop: 'ğŸš¿' } ] },
            { id: 11, title: 'Ø¯Ø±Ø³ Û±Û±: ÛŒ', words: [ { word: 'ÛŒØ®', letters: ['ÛŒÙ', 'Ø®'], crop: 'ğŸ§Š' }, { word: 'Ú†Ø§ÛŒ', letters: ['Ú†Ø§', 'ÛŒ'], crop: 'ğŸµ' }, { word: 'Ø¯Ø±ÛŒØ§', letters: ['Ø¯ÙØ±', 'ÛŒØ§'], crop: 'ğŸŒŠ' }, { word: 'Ù¾ÛŒØ§Ø²', letters: ['Ù¾Ù', 'ÛŒØ§Ø²'], crop: 'ğŸ§…' }, { word: 'Ø³Ø§ÛŒÙ‡', letters: ['Ø³Ø§', 'ÛŒÙ‡'], crop: 'ğŸŒ³' }, { word: 'Ù…ÛŒØ¯Ø§Ù†', letters: ['Ù…ÙÛŒ', 'Ø¯Ø§Ù†'], crop: 'ğŸŸï¸' } ] },
            { id: 12, title: 'Ø¯Ø±Ø³ Û±Û²: Ø§Ù Ù', words: [ { word: 'Ø§Ø±Ø¯Ú©', letters: ['Ø§ÙØ±', 'Ø¯ÙÚ©'], crop: 'ğŸ¦†' }, { word: 'Ø¨Ø²', letters: ['Ø¨Ù', 'Ø²'], crop: 'ğŸ' }, { word: 'Ú¯ÙÙ„', letters: ['Ú¯Ù', 'Ù„'], crop: 'ğŸŒ¸' }, { word: 'Ø³ÙØ±Ù…Ù‡', letters: ['Ø³ÙØ±', 'Ù…Ù‡'], crop: 'ğŸ‘ï¸â€ğŸ—¨ï¸' }, { word: 'Ø¯ÙØ±ÙØ³Øª', letters: ['Ø¯Ù', 'Ø±ÙØ³Øª'], crop: 'ğŸ‘' }, { word: 'Ù…ÙØ¯ÛŒØ±', letters: ['Ù…Ù', 'Ø¯ÛŒØ±'], crop: 'ğŸ‘”' } ] },
            { id: 13, title: 'Ø¯Ø±Ø³ Û±Û³: Ú©', words: [ { word: 'Ú©ØªØ§Ø¨', letters: ['Ú©Ù', 'ØªØ§Ø¨'], crop: 'ğŸ“š' }, { word: 'Ù†Ù…Ú©', letters: ['Ù†Ù', 'Ù…ÙÚ©'], crop: 'ğŸ§‚' }, { word: 'Ø¨Ø§Ø¯Ú©Ù†Ú©', letters: ['Ø¨Ø§Ø¯', 'Ú©Ù', 'Ù†ÙÚ©'], crop: 'ğŸˆ' }, { word: 'Ú©ÙˆØ¯Ú©', letters: ['Ú©Ùˆ', 'Ø¯ÙÚ©'], crop: 'ğŸ‘¶' }, { word: 'Ù†ÛŒÙ…Ú©Øª', letters: ['Ù†ÛŒÙ…', 'Ú©ÙØª'], crop: 'ğŸª‘' } ] },
            { id: 14, title: 'Ø¯Ø±Ø³ Û±Û´: Ùˆ', words: [ { word: 'ÙˆØ±Ø²Ø´', letters: ['ÙˆÙØ±', 'Ø²ÙØ´'], crop: 'âš½' }, { word: 'Ú¯Ø§Ùˆ', letters: ['Ú¯Ø§', 'Ùˆ'], crop: 'ğŸ„' }, { word: 'Ø¯ÛŒÙˆØ§Ø±', letters: ['Ø¯ÛŒ', 'ÙˆØ§Ø±'], crop: 'ğŸ§±' }, { word: 'Ø±ÙˆØ³ØªØ§', letters: ['Ø±ÙˆØ³', 'ØªØ§'], crop: 'ğŸ¡' }, { word: 'Ù†Ùˆ', letters: ['Ù†ÙÙˆ'], crop: 'âœ¨' } ] },
            { id: 15, title: 'Ø¯Ø±Ø³ Û±Ûµ: Ù¾ / Ú¯', words: [ { word: 'Ù¾Ø§Ø±Ú©', letters: ['Ù¾Ø§Ø±', 'Ú©'], crop: 'ğŸï¸' }, { word: 'Ú¯Ø±Ú¯', letters: ['Ú¯ÙØ±', 'Ú¯'], crop: 'ğŸº' }, { word: 'Ù¾Ø¯Ø±', letters: ['Ù¾Ù', 'Ø¯ÙØ±'], crop: 'ğŸ‘¨' }, { word: 'ØªÙˆÙ¾', letters: ['ØªÙˆ', 'Ù¾'], crop: 'âš½' }, { word: 'Ø¨Ø±Ú¯', letters: ['Ø¨ÙØ±', 'Ú¯'], crop: 'ğŸƒ' }, { word: 'Ø³Ú¯', letters: ['Ø³Ù', 'Ú¯'], crop: 'ğŸ¶' } ] },
            { id: 16, title: 'Ø¯Ø±Ø³ Û±Û¶: Ù / Ø®', words: [ { word: 'ÙØ±Ø´', letters: ['ÙÙØ±', 'Ø´'], crop: 'æ¯¯' }, { word: 'Ø´Ø§Ø®Ù‡', letters: ['Ø´Ø§', 'Ø®Ù‡'], crop: 'ğŸŒ¿' }, { word: 'Ù…ÛŒØ®', letters: ['Ù…ÛŒ', 'Ø®'], crop: 'ğŸ”©' }, { word: 'Ø¨Ø±Ù', letters: ['Ø¨ÙØ±', 'Ù'], crop: 'â„ï¸' }, { word: 'Ú©ÛŒÙ', letters: ['Ú©ÛŒ', 'Ù'], crop: 'ğŸ‘œ' }, { word: 'Ø³ÙØ±Ù‡', letters: ['Ø³ÙÙ', 'Ø±Ù‡'], crop: 'ğŸ½ï¸' }, { word: 'Ø´Ø§Ø®', letters: ['Ø´Ø§', 'Ø®'], crop: 'ğŸ¦Œ' } ] },
            { id: 17, title: 'Ø¯Ø±Ø³ Û±Û·: Ù‚ / Ù„', words: [ { word: 'Ù‚ÙˆØ±ÛŒ', letters: ['Ù‚Ùˆ', 'Ø±ÛŒ'], crop: 'ğŸ«–' }, { word: 'Ù‚Ø§Ø´Ù‚', letters: ['Ù‚Ø§', 'Ø´ÙÙ‚'], crop: 'ğŸ¥„' }, { word: 'Ù¾ÙˆÙ„', letters: ['Ù¾Ùˆ', 'Ù„'], crop: 'ğŸ’µ' }, { word: 'Ù‚Ù„Ø¨', letters: ['Ù‚ÙÙ„', 'Ø¨'], crop: 'â¤ï¸' }, { word: 'Ù‚Ù„Ù…', letters: ['Ù‚Ù', 'Ù„ÙÙ…'], crop: 'âœï¸' }, { word: 'Ú¯Ù„Ø§ÛŒÙ„', letters: ['Ú¯', 'Ù„Ø§', 'ÛŒÙÙ„'], crop: 'ğŸŒº' }, { word: 'Ø¨ÛŒÙ„', letters: ['Ø¨ÛŒ', 'Ù„'], crop: 'â›ï¸' } ] },
            { id: 18, title: 'Ø¯Ø±Ø³ Û±Û¸: Ø¬ / Ù‡', words: [ { word: 'Ø¬ÙˆØ±Ø§Ø¨', letters: ['Ø¬Ùˆ', 'Ø±Ø§Ø¨'], crop: 'ğŸ§¦' }, { word: 'Ø¨Ø±Ø¬', letters: ['Ø¨ÙØ±', 'Ø¬'], crop: 'ğŸ—¼' }, { word: 'Ù…Ø§Ù‡', letters: ['Ù…Ø§', 'Ù‡'], crop: 'ğŸŒ™' }, { word: 'Ú©Ø§Ø¬', letters: ['Ú©Ø§', 'Ø¬'], crop: 'ğŸŒ²' }, { word: 'Ø¬ÙˆØ¬Ù‡', letters: ['Ø¬Ùˆ', 'Ø¬Ù‡'], crop: 'ğŸ¥' }, { word: 'Ú©ÙˆÙ‡', letters: ['Ú©Ùˆ', 'Ù‡'], crop: 'â›°ï¸' } ] },
            { id: 19, title: 'Ø¯Ø±Ø³ Û±Û¹: Ú† / Ú˜', words: [ { word: 'Ú†ØªØ±', letters: ['Ú†ÙØª', 'Ø±'], crop: 'â˜‚ï¸' }, { word: 'Ù‚Ø§Ø±Ú†', letters: ['Ù‚Ø§Ø±', 'Ú†'], crop: 'ğŸ„' }, { word: 'Ú˜Ø§Ù„Ù‡', letters: ['Ú˜Ø§', 'Ù„Ù‡'], crop: 'ğŸ‘©' }, { word: 'Ú†ÙˆØ¨', letters: ['Ú†Ùˆ', 'Ø¨'], crop: 'ğŸªµ' }, { word: 'Ù¾Ø§Ø±Ú†Ù‡', letters: ['Ù¾Ø§Ø±', 'Ú†Ù‡'], crop: 'ğŸ§µ' }, { word: 'Ú˜Ø§Ú©Øª', letters: ['Ú˜Ø§', 'Ú©ÙØª'], crop: 'ğŸ§¥' } ] },
            { id: 20, title: 'Ø¯Ø±Ø³ Û²Û°: Ù€Ù‘ (ØªØ´Ø¯ÛŒØ¯)', words: [ { word: 'Ø¨Ù†Ù‘Ø§', letters: ['Ø¨ÙÙ†', 'Ù†Ø§'], crop: 'ğŸ‘·' }, { word: 'Ø§Ø±Ù‘Ù‡', letters: ['Ø§ÙØ±', 'Ø±Ù‡'], crop: 'ğŸªš' }, { word: 'Ù¾Ù„Ù‘Ù‡', letters: ['Ù¾ÙÙ„', 'Ù„Ù‡'], crop: 'ğŸ“¶' }, { word: 'Ø§ÙˆÙ‘Ù„', letters: ['Ø§ÙÙˆ', 'ÙˆÙÙ„'], crop: 'ğŸ¥‡' }, { word: 'Ø¨Ù‚Ù‘Ø§Ù„', letters: ['Ø¨ÙÙ‚', 'Ù‚Ø§Ù„'], crop: 'ğŸª' }, { word: 'Ø¯Ø±Ù‘Ù‡', letters: ['Ø¯ÙØ±', 'Ø±Ù‡'], crop: 'ğŸï¸' } ] },
        ].map(lesson => ({ ...lesson, isLocked: lesson.id !== 1 }));

        // --- GAME STATE ---
        const initialGameState = { coins: 0, farmPlots: Array(6).fill({ planted: null, isFertile: false }), completedWords: [], unlockedLessons: [1] };
        let gameState = JSON.parse(JSON.stringify(initialGameState));
        let selectedPlotIndex = null;
        let currentWord = null;
        let fertilePlotInterval = null;
        let scarecrowMessageCooldown = false;
        const SCARECOW_COOLDOWN_MS = 10000;

        let messageQueue = [];
        let isMessageVisible = false;
        let hasUserInteracted = false;

        // --- DOM ELEMENTS ---
        const coinCounter = document.getElementById('coin-counter');
        const farmGrid = document.querySelector('.grid');
        const seedModal = document.getElementById('seed-modal');
        const minigameModal = document.getElementById('minigame-modal');
        const messageModal = document.getElementById('message-modal');
        const lessonContainer = document.getElementById('lesson-container');
        const scarecrowSpeechBubble = document.getElementById('scarecrow-speech-bubble');
        const startGameOverlay = document.getElementById('start-game-overlay');
        const settingsModal = document.getElementById('settings-modal');
        const resetGameButton = document.getElementById('reset-game-button');

        // --- AUDIO ENGINE ---
        function playSound(filename) {
            if (!hasUserInteracted) return;
            // PWA ADDITION: Try to load sound from local files first, fallback to a generic sound if needed.
            // For simplicity, this example assumes sounds are optional or handled by the browser.
            // You might want to include sound files in your project and adjust the path.
            // const audio = new Audio(filename.startsWith('http') ? filename : `./sounds/${filename}`);
            const audio = new Audio(filename);
            audio.play().catch(() => {}); // Catch errors if file not found or autoplay fails
        }

        // --- DRAG & DROP LOGIC ---
        let draggedEl = null;

        function onPointerDown(e) {
            if (!e.target.classList.contains('letter-draggable')) return;
            e.preventDefault();
            draggedEl = e.target;
            const rect = draggedEl.getBoundingClientRect();
            const offsetX = (e.clientX || e.touches[0].clientX) - rect.left;
            const offsetY = (e.clientY || e.touches[0].clientY) - rect.top;
            const clone = draggedEl.cloneNode(true);
            draggedEl.style.opacity = '0.5';
            clone.classList.add('dragging');
            document.body.appendChild(clone);
            clone.style.left = ((e.clientX || e.touches[0].clientX) - offsetX) + 'px';
            clone.style.top = ((e.clientY || e.touches[0].clientY) - offsetY) + 'px';

            const onMove = (moveEvent) => {
                const currentX = moveEvent.clientX || moveEvent.touches[0].clientX;
                const currentY = moveEvent.clientY || moveEvent.touches[0].clientY;
                clone.style.left = (currentX - offsetX) + 'px';
                clone.style.top = (currentY - offsetY) + 'px';
                document.querySelectorAll('.letter-dropzone').forEach(zone => {
                    const zoneRect = zone.getBoundingClientRect();
                    if (currentX > zoneRect.left && currentX < zoneRect.right && currentY > zoneRect.top && currentY < zoneRect.bottom) {
                        zone.classList.add('drag-over');
                    } else {
                        zone.classList.remove('drag-over');
                    }
                });
            };

            const onUp = (upEvent) => {
                window.removeEventListener('pointermove', onMove);
                window.removeEventListener('pointerup', onUp);
                document.body.removeChild(clone);
                draggedEl.style.opacity = '1';
                const currentX = upEvent.clientX || upEvent.changedTouches[0].clientX;
                const currentY = upEvent.clientY || upEvent.changedTouches[0].clientY;
                document.querySelectorAll('.letter-dropzone').forEach(zone => {
                    zone.classList.remove('drag-over');
                    const zoneRect = zone.getBoundingClientRect();
                    if (currentX > zoneRect.left && currentX < zoneRect.right && currentY > zoneRect.top && currentY < zoneRect.bottom) {
                        validateDrop(zone, draggedEl);
                    }
                });
            };
            window.addEventListener('pointermove', onMove);
            window.addEventListener('pointerup', onUp);
        }

        function validateDrop(dropzone, originalEl) {
            if (dropzone.dataset.filled === 'true') return;
            const dropzoneIndex = parseInt(dropzone.dataset.index);
            const correctLetter = currentWord.letters[dropzoneIndex];
            if (originalEl.dataset.letter.normalize() === correctLetter.normalize()) {
                dropzone.textContent = originalEl.dataset.letter;
                dropzone.dataset.filled = 'true';
                dropzone.classList.add('border-green-500', 'bg-green-200', 'text-4xl', 'font-bold');
                originalEl.style.visibility = 'hidden';
                checkWordCompletion();
            } else {
                dropzone.classList.add('animate-shake');
                setTimeout(() => dropzone.classList.remove('animate-shake'), 500);
            }
        }

        minigameModal.addEventListener('pointerdown', onPointerDown);

        // --- GAME LOGIC FUNCTIONS ---
        function saveGame() { localStorage.setItem('wordFarmState', JSON.stringify(gameState)); }
        function loadGame() {
            const savedState = localStorage.getItem('wordFarmState');
            if (savedState) {
                gameState = JSON.parse(savedState);
                const unlockedIds = gameState.unlockedLessons || [1];
                lessons.forEach(lesson => {
                    lesson.isLocked = !unlockedIds.includes(lesson.id);
                });
            }
            updateUI();
        }
        function updateUI() {
            coinCounter.textContent = gameState.coins;
            renderFarm();
        }
        function renderFarm() {
            farmGrid.innerHTML = '';
            gameState.farmPlots.forEach((plot, index) => {
                const plotEl = document.createElement('div');
                plotEl.className = "farm-plot w-24 h-24 rounded-lg shadow-inner flex items-center justify-center cursor-pointer transform transition hover:scale-105";
                plotEl.dataset.index = index;
                if (plot.isFertile && !plot.planted) {
                    plotEl.classList.add('fertile-plot');
                }
                if (plot.planted) {
                    plotEl.innerHTML = `<span class="text-5xl crop-grown">${plot.planted.crop}</span>`;
                    plotEl.classList.add('planted');
                    plotEl.onclick = () => harvestPlot(index);
                } else {
                    plotEl.innerHTML = `<span class="text-2xl text-amber-200">+</span>`;
                    plotEl.onclick = () => openSeedModal(index);
                }
                farmGrid.appendChild(plotEl);
            });
        }
        function showScarecrowMessage(text, soundFile, duration = 4000) {
            if (scarecrowMessageCooldown) return;
            scarecrowMessageCooldown = true;

            scarecrowSpeechBubble.textContent = text;
            scarecrowSpeechBubble.classList.remove('hidden');
            if (soundFile) playSound(soundFile);

            setTimeout(() => scarecrowSpeechBubble.classList.add('hidden'), duration);
            setTimeout(() => { scarecrowMessageCooldown = false; }, SCARECOW_COOLDOWN_MS);
        }

        function queueMessage(icon, text, soundFile) {
            messageQueue.push({ icon, text, soundFile });
            processMessageQueue();
        }
        function processMessageQueue() {
            if (isMessageVisible || messageQueue.length === 0) return;
            isMessageVisible = true;
            const message = messageQueue.shift();
            document.getElementById('message-icon').textContent = message.icon;
            document.getElementById('message-text').textContent = message.text;
            messageModal.classList.remove('hidden');
            if(message.soundFile) playSound(message.soundFile);
        }
        function closeMessageModal() {
            messageModal.classList.add('hidden');
            isMessageVisible = false;
            setTimeout(processMessageQueue, 500);
        }

        function openSeedModal(plotIndex) {
            if (gameState.farmPlots[plotIndex].planted) return;
            selectedPlotIndex = plotIndex;
            lessonContainer.innerHTML = '';
            lessons.forEach(lesson => {
                const lessonDiv = document.createElement('div');
                const headerDiv = document.createElement('div');
                headerDiv.className = 'flex justify-between items-center mb-2';

                if (!lesson.isLocked) {
                    lessonDiv.className = 'border-2 border-amber-300 rounded-lg p-3';
                    headerDiv.innerHTML = `<h3 class="text-lg font-bold text-amber-700">${lesson.title}</h3>`;

                    const completedCount = lesson.words.filter(w => gameState.completedWords.includes(w.word)).length;
                    if (completedCount > 0) {
                        const restartButton = document.createElement('button');
                        restartButton.innerHTML = 'ğŸ”„';
                        restartButton.className = 'text-2xl transform transition hover:rotate-180';
                        restartButton.title = 'Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø§ÛŒÙ† Ø¯Ø±Ø³';
                        restartButton.onclick = (e) => { e.stopPropagation(); restartLesson(lesson.id); };
                        headerDiv.appendChild(restartButton);
                    }

                    lessonDiv.appendChild(headerDiv);

                    const wordsGrid = document.createElement('div');
                    wordsGrid.className = 'grid grid-cols-3 gap-2';
                    lesson.words.forEach(word => {
                        const isCompleted = gameState.completedWords.includes(word.word);
                        const wordButton = document.createElement('button');
                        wordButton.className = `p-2 rounded-lg text-xl font-bold transition transform hover:scale-110 ${ isCompleted ? 'bg-gray-300 text-gray-500 cursor-not-allowed' : 'bg-green-500 hover:bg-green-600 text-white' }`;
                        wordButton.textContent = word.word;
                        if (!isCompleted) wordButton.onclick = () => selectSeed(word);
                        else wordButton.disabled = true;
                        wordsGrid.appendChild(wordButton);
                    });
                    lessonDiv.appendChild(wordsGrid);
                } else {
                    lessonDiv.className = 'border-2 border-gray-300 rounded-lg p-3 bg-gray-100 text-gray-500 opacity-70';
                    headerDiv.innerHTML = `<h3 class="text-lg font-bold">${lesson.title} (Ù‚ÙÙ„) ğŸ”’</h3>`;
                    lessonDiv.appendChild(headerDiv);
                }
                 lessonContainer.appendChild(lessonDiv);
            });
            seedModal.classList.remove('hidden');
        }
        function closeSeedModal() { seedModal.classList.add('hidden'); }
        function selectSeed(word) {
            currentWord = word;
            closeSeedModal();
            startMinigame();
        }
        function startMinigame() {
            document.getElementById('minigame-image').textContent = currentWord.crop;
            const dropzonesContainer = document.getElementById('letter-dropzones');
            const draggablesContainer = document.getElementById('letter-draggables');
            dropzonesContainer.innerHTML = '';
            draggablesContainer.innerHTML = '';
            currentWord.letters.forEach((_, index) => {
                const zone = document.createElement('div');
                zone.className = 'letter-dropzone w-16 h-16 bg-white/70 rounded-lg border-2 border-dashed border-sky-400 flex items-center justify-center text-gray-400 text-2xl';
                zone.dataset.index = index;
                zone.textContent = '?';
                dropzonesContainer.appendChild(zone);
            });
            [...currentWord.letters].sort(() => Math.random() - 0.5).forEach(letter => {
                const el = document.createElement('div');
                el.className = 'letter-draggable w-16 h-16 bg-yellow-300 rounded-lg flex items-center justify-center text-3xl font-bold text-yellow-800';
                el.textContent = letter;
                el.dataset.letter = letter;
                draggablesContainer.appendChild(el);
            });
            minigameModal.classList.remove('hidden');
        }
        function closeMinigameModal() {
            minigameModal.classList.add('hidden');
            currentWord = null;
        }
        function checkWordCompletion() {
            const isComplete = Array.from(document.querySelectorAll('.letter-draggable')).every(el => el.style.visibility === 'hidden');
            if (isComplete) setTimeout(wordCompletedSuccessfully, 500);
        }
        function wordCompletedSuccessfully() {
            if (!currentWord) return;
            const completedWord = { ...currentWord };

            gameState.farmPlots[selectedPlotIndex].planted = completedWord;
            if (!gameState.completedWords.includes(completedWord.word)) {
                gameState.completedWords.push(completedWord.word);
            }

            closeMinigameModal();
            renderFarm();

            queueMessage('âœ…', `Ø¢ÙØ±ÛŒÙ†! Ú©Ù„Ù…Ù‡ "${completedWord.word}" Ú©Ø§Ø´ØªÙ‡ Ø´Ø¯!`, 'success.mp3');

            const unlockedLessonId = checkLessonUnlock(completedWord);
            if (unlockedLessonId) {
                const unlockedLesson = lessons.find(l => l.id === unlockedLessonId);
                queueMessage('ğŸ‰', `Ø¹Ø§Ù„ÛŒÙ‡! Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ "${unlockedLesson.title}" Ø¨Ø§Ø² Ø´Ø¯!`, 'unlock.mp3');
            }
            saveGame();
        }
        function checkLessonUnlock(completedWord) {
            const currentLesson = lessons.find(l => l.words.some(w => w.word === completedWord.word));
            if (!currentLesson) return null;

            const allWordsInLesson = currentLesson.words.map(w => w.word);
            const allWordsCompleted = allWordsInLesson.every(w => gameState.completedWords.includes(w));

            if (allWordsCompleted) {
                const nextLesson = lessons.find(l => l.id === currentLesson.id + 1);
                if (nextLesson && nextLesson.isLocked) {
                    nextLesson.isLocked = false;
                    if (!gameState.unlockedLessons.includes(nextLesson.id)) {
                        gameState.unlockedLessons.push(nextLesson.id);
                        return nextLesson.id;
                    }
                }
            }
            return null;
        }
        function harvestPlot(index) {
            const plot = gameState.farmPlots[index];
            if (!plot.planted) return;
            const coinsToAdd = plot.isFertile ? 10 : 5;
            const message = plot.isFertile ? `Ù…Ø­ØµÙˆÙ„ ÙˆÛŒÚ˜Ù‡! ${coinsToAdd} Ø³Ú©Ù‡ Ú¯Ø±ÙØªÛŒ! âœ¨` : `Ù…Ø­ØµÙˆÙ„ Ø®ÙˆØ¨ÛŒ Ø¨ÙˆØ¯! ${coinsToAdd} Ø³Ú©Ù‡ Ú¯Ø±ÙØªÛŒ!`;
            const soundFile = plot.isFertile ? 'harvest_bonus.mp3' : 'harvest_normal.mp3';

            const plotElement = document.querySelector(`.grid > div[data-index='${index}']`);
            const coinEl = document.createElement('span');
            coinEl.textContent = `ğŸ’°+${coinsToAdd}`;
            coinEl.className = 'coin-animation text-2xl font-bold text-yellow-500';
            plotElement.appendChild(coinEl);
            showScarecrowMessage(message, soundFile, 3000);
            setTimeout(() => {
                gameState.coins += coinsToAdd;
                gameState.farmPlots[index] = { planted: null, isFertile: false };
                updateUI();
                saveGame();
            }, 1000);
        }
        function startFertilePlotBonus() {
            clearInterval(fertilePlotInterval);
            fertilePlotInterval = setInterval(() => {
                gameState.farmPlots.forEach(p => p.isFertile = false);
                const emptyPlotsIndexes = [];
                gameState.farmPlots.forEach((plot, index) => { if (!plot.planted) emptyPlotsIndexes.push(index); });
                if (emptyPlotsIndexes.length > 0) {
                    const randomIndex = emptyPlotsIndexes[Math.floor(Math.random() * emptyPlotsIndexes.length)];
                    gameState.farmPlots[randomIndex].isFertile = true;
                    showScarecrowMessage("ÛŒÚ© Ø²Ù…ÛŒÙ† Ø­Ø§ØµÙ„Ø®ÛŒØ² Ø´Ø¯! Ø¹Ø¬Ù„Ù‡ Ú©Ù†!", 'fertile.mp3', 4000);
                }
                renderFarm();
                setTimeout(() => {
                    const fertilePlot = gameState.farmPlots.find(p => p.isFertile);
                    if (fertilePlot) {
                        fertilePlot.isFertile = false;
                        renderFarm();
                    }
                }, 15000);
            }, 20000);
        }

        // Settings Functions
        function openSettingsModal() { settingsModal.classList.remove('hidden'); }
        function closeSettingsModal() { settingsModal.classList.add('hidden'); }

        function resetGame() {
            if (resetGameButton.dataset.confirm === 'true') {
                localStorage.removeItem('wordFarmState');
                window.location.reload();
            } else {
                resetGameButton.textContent = 'Ø¢ÛŒØ§ Ù…Ø·Ù…Ø¦Ù† Ù‡Ø³ØªÛŒØ¯ØŸ';
                resetGameButton.classList.remove('bg-red-500', 'hover:bg-red-700');
                resetGameButton.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                resetGameButton.dataset.confirm = 'true';
                setTimeout(() => {
                    resetGameButton.textContent = 'Ø´Ø±ÙˆØ¹ Ù…Ø¬Ø¯Ø¯ Ø¨Ø§Ø²ÛŒ';
                    resetGameButton.classList.add('bg-red-500', 'hover:bg-red-700');
                    resetGameButton.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    resetGameButton.dataset.confirm = 'false';
                }, 3000);
            }
        }
        function restartLesson(lessonId) {
            const lessonWords = lessons.find(l => l.id === lessonId)?.words.map(w => w.word) || [];
            if (lessonWords.length > 0) {
                gameState.completedWords = gameState.completedWords.filter(word => !lessonWords.includes(word));
                saveGame();
                const currentPlotIndex = selectedPlotIndex;
                closeSeedModal();
                openSeedModal(currentPlotIndex);
            }
        }

        // PWA ADDITION: Register the Service Worker
        function init() {
            loadGame();
            startGameOverlay.addEventListener('click', () => {
                hasUserInteracted = true;
                startGameOverlay.classList.add('hidden');
                showScarecrowMessage("Ø¨Ù‡ Ù…Ø²Ø±Ø¹Ù‡ Ú©Ù„Ù…Ø§Øª Ø®ÙˆØ´ Ø§ÙˆÙ…Ø¯ÛŒ!", 'welcome.mp3', 4000);
                startFertilePlotBonus();
            }, { once: true });

            resetGameButton.addEventListener('click', resetGame);

            // PWA ADDITION: Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    navigator.serviceWorker.register('./sw.js')
                        .then(registration => {
                            console.log('Service Worker registered with scope:', registration.scope);
                        })
                        .catch(error => {
                            console.log('Service Worker registration failed:', error);
                        });
                });
            }
            // End PWA ADDITION
        }

        init();
    </script>
</body>
</html>